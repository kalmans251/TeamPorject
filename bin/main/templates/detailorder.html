
<html layout:decorate="~{layout}">
<head>
	<script src="/jquery-3.6.3.min.js"></script>
	<meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<div layout:fragment="content">
	<input id="itemId" type="hidden" th:value="${itemId}">
	
	<div>
		<select id="orderNum">
		  <option th:each="isi:${isiList}" th:text="${isi.id}+${isi.color.name}+${isi.size.name}" th:value="${isi.id}"></option>
		</select>
		<input type="number" id="countNum" >
		<button onclick="addCart()">add to cart</button>
		<button onclick="order()">buy now</button>
		<button onclick="favor()">별</button>
	</div>
	
	
	
</div>
<script layout:fragment="javascriptContent">
	const orderNum= document.getElementById('orderNum');
	const countNum= document.getElementById('countNum');
	
	function addCart(){
		
		if(orderNum.value==""||countNum.value==""){
			alert("장바구니등록:상품옵션과 갯수를 입력해주세요.");
			return null;
		}
		
		var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
			
        let params={
					id:orderNum.value,
					count:countNum.value
			};
			
			$.ajax ({		
				type:"get",
				url:"/isCart",
				// parameter 값을 서버로 전송 하기 
				data:{itemSellingInformId:orderNum.value},
				
				//요청이 성공했을때 실행되는 부분 
				success:function(res){
					
					if(res==1){
						if(confirm("이미 등록된 상품입니다. 상품을 추가하시겠습니까?")){
							$.ajax ({		
								type:"post",
								url:"/cartCountAddAjax",
								
								data:params,
								beforeSend : function(xhr){
					                xhr.setRequestHeader(header, token);
					            },
								success:function(res){
									alert(res)
									
								},
								error:function(){
									alert("통신실패")
								}			
							})
						}else{
							return null;
						}
					}else{
						$.ajax ({		
							type:"post",
							url:"/cartAddAjax",
							
							data:params,
							beforeSend : function(xhr){
				                xhr.setRequestHeader(header, token);
				            },
							success:function(res){
								alert("장바구니 추가 완료")
								
							},
							error:function(){
								alert("장바구니 추가 실패")
							}			
						})
					}
				},
				
				//요청이 실패 했을때 실행되는 블락 (예외 처리 )
				error:function(){
					alert("장바구니 추가 실패")
					
				}			
			})
	}
	
	
	
	function order(){
		
		if(orderNum.value==""||countNum.value==""){
			alert("구매하기:상품옵션과 갯수를 입력해주세요.");
			return null;
		}
		
		location.href="/orderform/"+orderNum.value+"?counts="+countNum.value+"&id="+orderNum.value;
	}
	
	function favor(){
		var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
			
        let params={
					id:document.getElementById('itemId').value,
			};
			
			$.ajax ({		
				type:"post",
				url:"/addfavor",

				data:params,
				beforeSend : function(xhr){
	                xhr.setRequestHeader(header, token);
	            },

				success:function(res){
					alert(res);
				},

				error:function(){
					alert("통신실패");
				}			
			})
	}
	
	
	
</script>
</html>