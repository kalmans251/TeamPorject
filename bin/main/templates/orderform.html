<html layout:decorate="~{layout}">
<head>

<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<script src="/jquery-3.6.3.min.js"></script>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

</head>
<div layout:fragment="content">

<h2 style="margin:0 auto;width:fit-content;margin-top:50px;"> 주문서 작성</h2>
<table style="margin:0 auto;width:600px;">
<input id="isiId" type="hidden" th:value="${isiId}">
	<tr>
		<td>상품정보</td><td></td><td></td>
	</tr>

	<tr>
		<td>
			<div>
				<img style="float:left;width:100px;height:100px;" th:src="${orderDto.url}">
				
				<ul>
					<li id="subject" th:text="${orderDto.subject}"></li>
					<li><span id="price" th:text="${orderDto.price}"></span>원</li>
					<li> [옵션:<span th:text="${orderDto.color}"></span>/<span th:text="${orderDto.size}"></span>]</li>
					<li>QTY: <span id="count" th:text="${orderDto.orderCount}"></span></li>
				</ul>
			</div>
		</td>
		
		<td></td>
		
		<td></td>
	</tr>
	<tr>
		<td>주문정보</td>
		<td></td>
		<td></td>
	</tr>
</table>
<div style="width:600px;margin:0 auto;">
<div align="center"  id="disable">
	<div th:text="${orderDto.member.nickName}" id="buyerName"></div>
	<span>전화번호:</span><input th:value="${orderDto.member.phoneNum}" id="phone">
</div>
		<div class="input-group input-group-sm mb-3">
					<span style="width:110px;" class="input-group-text" id="inputGroup-sizing-sm">주소</span>
					<input placeholder="우편번호" id="sample6_postcode" type="text" name="addr1" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
			<input type="button" onclick="sample6_execDaumPostcode()" value="우편번호 찾기">
		</div>
		<div class="input-group input-group-sm mb-3">
					<input  placeholder="주소" type="text" id="sample6_address" name="addr2" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
					<input  placeholder="참고항목" type="text" id="sample6_extraAddress" name="reference" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
		</div>
		<div class="input-group input-group-sm mb-3">
					<input  placeholder="상세주소" type="text" id="sample6_detailAddress" name="addr3" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
		</div>
		<div style="margin-bottom:30px;margin:0 auto;width:fit-content;" id="calcPrice"></div>
	  	<div style="margin-bottom:30px;margin:0 auto;width:fit-content;"><button style="margin:0 auto" onclick="requestPay()">결제하기</button></div>
</div>
	
</div> 

	

<script layout:fragment="javascriptContent">
	
	const count = document.getElementById('count');
	const price = document.getElementById('price'); 
	const isiId = document.getElementById('isiId');
	const calcPrice = document.getElementById('calcPrice');
	let total = count.innerText*price.innerText;
	calcPrice.innerText='결제금액:'+total.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",")+'원';
	
	var IMP = window.IMP;
	IMP.init("imp57806750");
	
	
	const subject = document.getElementById('subject');
	const buyerName = document.getElementById('buyerName');
	const phone = document.getElementById('phone');
	const addr1 = document.getElementById('sample6_address');
	const addr2 = document.getElementById('sample6_extraAddress');
	const addr3 = document.getElementById('sample6_detailAddress');
	const postcode = document.getElementById('sample6_postcode');

	
	function sample6_execDaumPostcode() {
	    new daum.Postcode({
	        oncomplete: function(data) {
	
	            var addr = ''; 
	            var extraAddr = ''; 
	            if (data.userSelectedType === 'R') {
	                addr = data.roadAddress;
	            } else {
	                addr = data.jibunAddress;
	            }
	            if(data.userSelectedType === 'R'){
	                if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
	                    extraAddr += data.bname;
	                }
	                // 건물명이 있고, 공동주택일 경우 추가한다.
	                if(data.buildingName !== '' && data.apartment === 'Y'){
	                    extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
	                }
	                // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
	                if(extraAddr !== ''){
	                    extraAddr = ' (' + extraAddr + ')';
	                }
	                // 조합된 참고항목을 해당 필드에 넣는다.
	                document.getElementById("sample6_extraAddress").value = extraAddr;
	            
	            } else {
	                document.getElementById("sample6_extraAddress").value = '';
	            }
	
	            document.getElementById('sample6_postcode').value = data.zonecode;
	            document.getElementById("sample6_address").value = addr;
	            document.getElementById("sample6_detailAddress").focus();
	        }
	    }).open();
	}
	
	
	function getToken(){
		var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
        
		$.ajax({
			url:"https://api.iamport.kr/users/getToken",
			method: "post",
			headers: { "Content-Type": "application/json"
			},
			beforeSend : function(xhr){
                xhr.setRequestHeader(header, token);
            },
            data: {
                imp_key: "1316173255877318", // REST API 키
                imp_secret: "lUB6JL8jzRq5nktPytzoO8pkOzZIwEWADhMx72C7XVzJf6riHWm8dY2uQBokTy4cyEg5cCCzzeV81gAJ"
            }
		}).done(function (data) {
			console.log(data);
		});
	}
	
	function requestPay() {
		var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
        
        $.ajax({
	        url: "/checkcount", 
	        method: "POST",
	        beforeSend : function(xhr){
                xhr.setRequestHeader(header, token);
            },
	        data: {
	          buyCount:count.innerText,
	          id:isiId.value
	        }
	      }).done(function (data) {
	        if(data==="재고없음"){
	        	alert(data);
	        }else{
	        	IMP.request_pay({
	    			pg : 'inicis',
	    			pay_method : 'card',
	    			merchant_uid : "",
	    			name : subject.innerText,
	    			amount : total,
	    			buyer_email : 'my03262@naver.com',
	    			buyer_name : buyerName.innerText,
	    			buyer_tel : phone.value,
	    			buyer_addr : addr1.value+"/"+addr2.value+"/"+addr3.value,
	    			buyer_postcode : postcode.value
	    		}, function(rsp) { // callback
	    			if (rsp.success) {
	    				// 결제 성공 시: 결제 승인 또는 가상계좌 발급에 성공한 경우
	    			      // jQuery로 HTTP 요청
	    			      console.log(rsp.imp_uid);
	    		
	    			      $.ajax({
	    			        url: "/save", 
	    			        method: "POST",
	    			        beforeSend : function(xhr){
	    		                xhr.setRequestHeader(header, token);
	    		            },
	    			        data: {
	    			          imp_uid: rsp.imp_uid,            // 결제 고유번호
	    			          merchant_uid: rsp.merchant_uid,   // 주문번호
	    			          buyCount:count.innerText,
	    			          id:isiId.value
	    			        }
	    			      }).done(function (data) {
	    			        console.log(data);
	    			        alert(data);
	    			      })
	    			} else {
	    				
	    				$.ajax({
	    			        url: "/rollbackcount", 
	    			        method: "POST",
	    			        beforeSend : function(xhr){
	    		                xhr.setRequestHeader(header, token);
	    		            },
	    			        data: {
	    			          buyCount:count.innerText,
	    			          id:isiId.value
	    			        }
	    			      }).done(function (data) {
	    			        alert(data);
	    			      })
	    			}
	    		});
	        }
	      })	
        
		
	}
	
	function canclePay() {
	    $.ajax({
	      // 예: http://www.myservice.com/payments/cancel
	      "url": "https://www.weawea.com", 
	      "type": "POST",
	      "contentType": "application/json",
	      "data": JSON.stringify({
	        "merchant_uid": "nobody_1680679656859", // 예: ORD20180131-0000011
	        "cancel_request_amount": 100, // 환불금액
	        "reason": "테스트 결제 환불", // 환불사유
	        // [가상계좌 환불시 필수입력] 환불 수령계좌 예금주
	        "refund_holder": "김지수", 
	        // [가상계좌 환불시 필수입력] 환불 수령계좌 은행코드(예: KG이니시스의 경우 신한은행은 88번)
	        "refund_bank": "20" ,
	        // [가상계좌 환불시 필수입력] 환불 수령계좌 번호
	        "refund_account": "1002743321262" 
	      }),
	      "dataType": "json"
	    });
	  }
</script>


</html>