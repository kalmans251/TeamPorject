<html layout:decorate="~{layout}">
<head>

<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<script src="/jquery-3.6.3.min.js"></script>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

</head>
<div layout:fragment="content">

<h2> 주문서 작성</h2>

<h3>상품정보</h3>
	
	<input id="isiId" type="hidden" th:value="${isiId}">
	<img style="width:100px;height:100px;" th:src="${orderDto.url}">
	<div th:text="${orderDto.subject}" id="subject"></div>
	상품사이즈<div th:text="${orderDto.size}"></div>
	상품색상<div th:text="${orderDto.color}"></div>
	상품가격<div id="price" th:text="${orderDto.price}"></div>
	상품수량<div id="count" th:text="${orderDto.orderCount}"></div>
	
	<div th:text="${orderDto.member.nickName}" id="buyerName"></div>
	<div th:text="${orderDto.member.phoneNum}" id="phone"></div>
	<div th:text="${orderDto.memberAdress}" id="addr"></div>
	<div th:text="${orderDto.memberAdress}" id="postcode"></div>	

	<div id="calcPrice"><span></span></div>
	<button onclick="requestPay()">결제하기</button>
<!-- 	<button onclick="getToken()">토큰받기</button> -->
</div>

	

<script layout:fragment="javascriptContent">
	
	const count = document.getElementById('count');
	const price = document.getElementById('price'); 
	const isiId = document.getElementById('isiId');
	const calcPrice = document.getElementById('calcPrice');
	let total = count.innerText*price.innerText;
	calcPrice.innerText='결제금액:'+total.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",")+'원';
	
	var IMP = window.IMP;
	IMP.init("imp57806750");
	
	
	const subject = document.getElementById('subject');
	const buyerName = document.getElementById('buyerName');
	const phone = document.getElementById('phone');
	const addr = document.getElementById('addr');
	const postcode = document.getElementById('postcode');
	console.log(location.origin);
	function getToken(){
		var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
        
		$.ajax({
			url:"https://api.iamport.kr/users/getToken",
			method: "post",
			headers: { "Content-Type": "application/json"
			},
			beforeSend : function(xhr){
                xhr.setRequestHeader(header, token);
            },
            data: {
                imp_key: "1316173255877318", // REST API 키
                imp_secret: "lUB6JL8jzRq5nktPytzoO8pkOzZIwEWADhMx72C7XVzJf6riHWm8dY2uQBokTy4cyEg5cCCzzeV81gAJ"
            }
		}).done(function (data) {
			console.log(data);
		});
	}
	
	function requestPay() {
		var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
        
        $.ajax({
	        url: "/checkcount", 
	        method: "POST",
	        beforeSend : function(xhr){
                xhr.setRequestHeader(header, token);
            },
	        data: {
	          buyCount:count.innerText,
	          id:isiId.value
	        }
	      }).done(function (data) {
	        if(data==="재고없음"){
	        	alert(data);
	        }else{
	        	IMP.request_pay({
	    			pg : 'inicis',
	    			pay_method : 'card',
	    			merchant_uid : "",
	    			name : subject.innerText,
	    			amount : total,
	    			buyer_email : 'my03262@naver.com',
	    			buyer_name : buyerName.innerText,
	    			buyer_tel : phone.innerText,
	    			buyer_addr : addr.innerText,
	    			buyer_postcode : postcode.innerText
	    		}, function(rsp) { // callback
	    			if (rsp.success) {
	    				// 결제 성공 시: 결제 승인 또는 가상계좌 발급에 성공한 경우
	    			      // jQuery로 HTTP 요청
	    			      console.log(rsp.imp_uid);
	    		
	    			      $.ajax({
	    			        url: "/save", 
	    			        method: "POST",
	    			        beforeSend : function(xhr){
	    		                xhr.setRequestHeader(header, token);
	    		            },
	    			        data: {
	    			          imp_uid: rsp.imp_uid,            // 결제 고유번호
	    			          merchant_uid: rsp.merchant_uid,   // 주문번호
	    			          buyCount:count.innerText,
	    			          id:isiId.value
	    			        }
	    			      }).done(function (data) {
	    			        console.log(data);
	    			        alert(data);
	    			      })
	    			} else {
	    				
	    				$.ajax({
	    			        url: "/rollbackcount", 
	    			        method: "POST",
	    			        beforeSend : function(xhr){
	    		                xhr.setRequestHeader(header, token);
	    		            },
	    			        data: {
	    			          buyCount:count.innerText,
	    			          id:isiId.value
	    			        }
	    			      }).done(function (data) {
	    			        alert(data);
	    			      })
	    			}
	    		});
	        }
	      })	
        
		
	}
	
	function canclePay() {
	    $.ajax({
	      // 예: http://www.myservice.com/payments/cancel
	      "url": "https://www.weawea.com", 
	      "type": "POST",
	      "contentType": "application/json",
	      "data": JSON.stringify({
	        "merchant_uid": "nobody_1680679656859", // 예: ORD20180131-0000011
	        "cancel_request_amount": 100, // 환불금액
	        "reason": "테스트 결제 환불", // 환불사유
	        // [가상계좌 환불시 필수입력] 환불 수령계좌 예금주
	        "refund_holder": "김지수", 
	        // [가상계좌 환불시 필수입력] 환불 수령계좌 은행코드(예: KG이니시스의 경우 신한은행은 88번)
	        "refund_bank": "20" ,
	        // [가상계좌 환불시 필수입력] 환불 수령계좌 번호
	        "refund_account": "1002743321262" 
	      }),
	      "dataType": "json"
	    });
	  }
</script>


</html>