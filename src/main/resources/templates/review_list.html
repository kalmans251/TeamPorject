<html layout:decorate="~{layout}">
<head>
<script src="/jquery-3.6.3.min.js"></script>
<script
	src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<style>
.star {
	position: relative;
	font-size: 2rem;
	color: lightgrey;
}

.star input {
	width: 100%;
	height: 100%;
	position: absolute;
	left: 0;
	opacity: 0;
	cursor: pointer;
}

.star span {
	width: 0;
	position: absolute;
	left: 0;
	color: red;
	pointer-events: none;
}

#reimg {
	float: left;
	margin: 50px 3px -50px 10px;
}

.clear {
	clear: both;
}

#plusImg {
	float: right;
}
#ctnt{
	height:200px;
}

</style>
<script>
	function addImage() {
		// 새로운 이미지 입력 필드와 삭제 버튼을 감싸는 div를 생성
		var newImgDiv = document.createElement("div");
		newImgDiv.className = "img-div";
		newImgDiv.innerHTML = '<label for="file"></label><input style="width:400px;" type="file" id="inputGroupFile04" name="file" accept="image/*" class="form-control" aria-describedby="inputGroupFileAddon04" aria-label="Upload" ><input type="button" value="Delete" onclick="removeImage(this)" class="btn btn-outline-danger">';

		// 새로운 이미지 입력 필드를 기존의 필드들 바로 밑에 추가
		var imgContainer = document.getElementById("plusImg");
		imgContainer.parentNode.insertBefore(newImgDiv,
				imgContainer.nextSibling);
	}

	function removeImage(btn) {
		// 삭제 버튼이 속한 div를 찾아서 삭제
		var imgDiv = btn.parentNode;
		imgDiv.parentNode.removeChild(imgDiv);
	}
</script>
</head>

<div layout:fragment="content" class="container my-3">
	<div class="card my-3" th:each="review, loop : ${paging}">
		<div>
			<div>
				<div th:text="${review.content}"></div>
				<div class="clear"></div>

				<div th:each="reviewImg : ${review.reviewImg}">
					<img th:src="${reviewImg.url}" id="reimg"
						style="width: 150px; height: 150px;">
				</div>
				<div class="clear"></div>
				<div class="d-flex justify-content-end">
					<div th:if="${review.modifyDate != null}"
						class="badge bg-light text-dark p-2 text-start mx-3">
						<div class="mb-2">수정됨</div>
						<div
							th:text="${#temporals.format(review.modifyDate, 'yyyy-MM-dd HH:mm')}"></div>
					</div>
					<div class="badge bg-light text-dark p-2 text-start">
						<div class="mb-2">
							<span th:if="${review.author != null}"
								th:text="${review.author.nickName}"></span>
						</div>
						<div
							th:text="${#temporals.format(review.createDate, 'yyyy-MM-dd HH:mm')}"></div>
					</div>
				</div>
				<div class="my-3">
					<a th:href="@{|/review/vote/${review.id}|}"
						class="recommend btn  btn-outline-secondary"> <svg
							xmlns="http://www.w3.org/2000/svg" width="16" height="16"
							fill="currentColor" class="bi bi-suit-heart-fill"
							viewBox="0 0 16 16">
       				 <path
								d="M4 1c2.21 0 4 1.755 4 3.92C8 2.755 9.79 1 12 1s4 1.755 4 3.92c0 3.263-3.234 4.414-7.608 9.608a.513.513 0 0 1-.784 0C3.234 9.334 0 8.183 0 4.92 0 2.755 1.79 1 4 1z" />
   					 </svg> 좋아요 <span class="badge rounded-pill bg-success"
						th:text="${#lists.size(review.voter)}"></span>
					</a> <a th:href="@{|/review/modify/${review.id}|}"
						class="btn btn-sm btn-outline-secondary"
						sec:authorize="isAuthenticated()"
						th:if="${review.author != null and #authentication.getPrincipal().name == review.author.token}"
						th:text="수정"></a> <a th:href="@{|/review/delete/${review.id}|}"
						class="delete btn btn-sm btn-outline-secondary"
						sec:authorize="isAuthenticated()"
						th:if="${review.author != null and #authentication.getPrincipal().name == review.author.token}"
						th:text="삭제"></a>
				</div>
			</div>
		</div>
	</div>


	<div class="card my-3">
		<div class="board" style="align-items: center;">
			<form th:action="@{|/review/create/${item.id}|}"
				th:object="${reviewForm}" method="post"
				enctype="multipart/form-data">
				<div class="mb-3">
					<div>
						<label for="star"></label> <span class="star"> ★★★★★ <span
							style="white-space: nowrap; overflow: hidden; height: 50px;">★★★★★</span>
							<input type="range" oninput="drawStar(this)" value="1" step="1"
							min="0" max="10">
						</span>
					</div>

					<div class="content">
						<label for="content"></label>
						<textarea id="ctnt" th:field="*{content}" class="form-control"></textarea>
					</div>
					<div id="plusImg" style="margin-bottom: 10px; width: 500px"
						class="input-group">
						<label for="img" style="width: 120px;" class="input-group-text">Image
						</label> <input type="file" id="inputGroupFile04" name="file"
							accept="image/*" class="form-control"
							aria-describedby="inputGroupFileAddon04" aria-label="Upload">
						<input type="button" name="plusImg" value="img+"
							onclick="addImage()" id="inputGroupFileAddon04"
							class="btn btn-outline-secondary">
					</div>
					<div id="btn2-sc">
						<br> <input type="submit" value="등록" class="write-btn" />
						<button type="button" value="취소" class="cancel">취소</button>
					</div>
			</form>
		</div>
	</div>
	<!-- 페이징처리 시작 -->
	<div th:if="${!paging.isEmpty()}">
		<ul class="pagination justify-content-center">
			<li class="page-item"
				th:classappend="${!paging.hasPrevious} ? 'disabled'"><a
				class="page-link" href="javascript:void(0)"
				th:data-page="${paging.number-1}"> <span>이전</span>
			</a></li>
			<li th:each="page: ${#numbers.sequence(0, paging.totalPages-1)}"
				th:if="${page >= paging.number-5 and page <= paging.number+5}"
				th:classappend="${page == paging.number} ? 'active'"
				class="page-item"><a th:text="${page+1}" class="page-link"
				href="javascript:void(0)" th:data-page="${page}"></a></li>
			<li class="page-item"
				th:classappend="${!paging.hasNext} ? 'disabled'"><a
				class="page-link" href="javascript:void(0)"
				th:data-page="${paging.number+1}"> <span>다음</span>
			</a></li>
		</ul>
		<!-- 페이징처리 끝 -->
		<form th:action="@{/review/list}" method="get" id="searchForm">
			<input type="hidden" id="kw" name="kw" th:value="${kw}"> <input
				type="hidden" id="page" name="page" th:value="${paging.number}">
		</form>

	</div>

	<script layout:fragment="javascriptContent" type='text/javascript'>
		const page_elements = document.getElementsByClassName("page-link");
		Array.from(page_elements).forEach(function(element) {
			element.addEventListener('click', function() {
				document.getElementById('page').value = this.dataset.page;
				document.getElementById('searchForm').submit();
			});
		});
		const btn_search = document.getElementById("btn_search");
		btn_search.addEventListener('click', function() {
			document.getElementById('kw').value = document
					.getElementById('search_kw').value;
			document.getElementById('page').value = 0; // 검색버튼을 클릭할 경우 0 페이지부터 조회한다.
			document.getElementById('searchForm').submit();
		});
		const delete_elements = document.getElementsByClassName("delete");
		Array.from(delete_elements).forEach(function(element) {
			element.addEventListener('click', function() {
				if (confirm("정말로 삭제하시겠습니까?")) {
					location.href = this.dataset.uri;
				}
				;
			});
		});
		const recommend_elements = document.getElementsByClassName("recommend");
		Array.from(recommend_elements).forEach(function(element) {
			element.addEventListener('click', function() {
				if (confirm("정말로 추천하시겠습니까?")) {
					location.href = this.dataset.uri;
				}
				;
			});
		});

		function drawStar(target) {
			document.querySelector(`.star span`).style.width = `${target.value * 10}%`;
			console.log(target.value / 2);
		};
	</script>
</html>